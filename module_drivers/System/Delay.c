///*
//#include "Delay.h"


//// ???????????λ??Hz??
//#define SYSTEM_CLOCK_FREQ 168000000
//static __IO uint32_t uwTimingDelay;

//void TimingDelay_Decrement(void)
//{
//  if (uwTimingDelay != 0x00)
//  { 
//    uwTimingDelay--;
//  }
//}

///**
//  * @brief  ?????SysTick?????
//  * @param  ??
//  * @retval ??
//  */
//void Delay_Init(void) {
//    // ????SysTick????????????168MHz??
//    SysTick->CTRL |= SysTick_CTRL_CLKSOURCE_Msk;
//}

///**
//  * @brief  ??????
//  * @param  us ???????????????Χ??1~798915
//  * @retval ??
//  */
//void Delay_us(uint32_t us) {
//    // ????????????????????168MHz?1us=168?????
//    uint32_t ticks = us * (SYSTEM_CLOCK_FREQ / 1000000);
//    
//    // ????????????24λ????0xFFFFFF??
//    SysTick->LOAD = (ticks - 1) & 0xFFFFFF;
//    
//    // ??????
//    SysTick->VAL = 0;
//    
//    // ?????????
//    SysTick->CTRL |= SysTick_CTRL_ENABLE_Msk;
//    
//    // ??????????
//    while (!(SysTick->CTRL & SysTick_CTRL_COUNTFLAG_Msk));
//    
//    // ???????
//    SysTick->CTRL &= ~SysTick_CTRL_ENABLE_Msk;
//}

///**
//  * @brief  ???????
//  * @param  ms ????????????????Χ??1~4294967295
//  * @retval ??
//  */
//void Delay_ms(uint32_t ms) {
//    // ????С??798ms???????????us?????
//    if (ms <= 798) {
//        Delay_us(ms * 1000);
//    } 
//    // ????798ms??????????
//    else {
//        while (ms--) {
//            // ??????798ms???????????
//            uint32_t chunks = ms > 798 ? 798 : ms;
//            Delay_us(chunks * 1000);
//            ms -= chunks;
//        }
//    }
//}

///**
//  * @brief  ?????
//  * @param  s ??????????????Χ??1~4294967295
//  * @retval ??
//  */
//void Delay_s(uint32_t s) {
//    while (s--) {
//        Delay_ms(1000);
//    }
//}
//g
//*/




#include "Delay.h"
#include "stm32f4xx.h"


void Delay_Init(void)
{
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);

    TIM_TimeBaseInitTypeDef TIM_Init;
    TIM_Init.TIM_Prescaler = (SystemCoreClock / 1000000) - 1;  // 1 MHz -> 1 μs 分辨率
    TIM_Init.TIM_Period = 0xFFFFFFFF;  // 最大周期，延时用轮询实现
    TIM_Init.TIM_ClockDivision = TIM_CKD_DIV1;
    TIM_Init.TIM_CounterMode = TIM_CounterMode_Up;
    TIM_TimeBaseInit(TIM2, &TIM_Init);

    TIM_Cmd(TIM2, ENABLE);
}

void Delay_us(uint32_t us)
{
    uint32_t start = TIM_GetCounter(TIM2);
    while ((TIM_GetCounter(TIM2) - start) < us);
}

void Delay_ms(uint32_t ms)
{
    while (ms--) {
        Delay_us(1000);
    }
}

void Delay_s(uint32_t s)
{
    while (s--) {
        Delay_ms(1000);
    }
}

